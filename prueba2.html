<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Brecha Salarial por Región</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <style>
    :root{
      --accent: #b30000;
      --text-main: #111827;
      --bg: #EDEDED;
    }
    *{ box-sizing: border-box; }
    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      margin: 0;
    }
    .page{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .headline{
      text-align: center;       /* título a la izquierda */
      margin: 8px 0 16px;
      line-height: 1.12;
    }
    .headline h1{
      margin: 0;
      font-size: clamp(28px, 5vw, 44px);
      font-weight: 150;
      color: var(--text-main);
    }
    .headline h1 b{ font-weight: 600; }
    .headline .accent{ color: var(--accent); }

    /* === SPLIT IZQUIERDA / DERECHA === */
    .split{
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }
    .left{
      flex: 1 1 58%;
      min-width: 0; /* evita overflow */
    }
    .right{
      flex: 1 1 42%;
      min-width: 0;
    }

    /* Contenido específico */
    #mapa{
      width: 100%;
      height: 600px;
      background: var(--bg);
      border-radius: 8px;
    }
    .desc{
      padding: 8px 12px 0 12px;
      text-align: justify;
      font-size: clamp(14px, 1.6vw, 18px);
      line-height: 1.55;
      color: #374151;
    }
    .desc p{ margin: 0 0 10px; }

    .sections{ margin-top: 18px; }
    .section{ margin: 18px 0; }
    .section h3{
      margin: 0 0 6px;
      font-weight: 600;
      font-size: 18px;
      color: var(--text-main);
    }
    .section hr{
      border: none;
      border-top: 1px solid #cfcfcf;
    }
    .chart{
      height: 180px;    /* ajusta para hacer barras más flacas/gruesas */
      background: var(--bg);
      border-radius: 6px;
      
    }

    #chartDisparejos.chart{
      height: 180px;    /* ajusta para hacer barras más flacas/gruesas */
      background: var(--bg);

    }
    #chartCapital.chart{ height: 70px; }

    /* Responsive: apilar en pantallas pequeñas */
    @media (max-width: 992px){
      .split{ flex-direction: column; }
      #mapa{ height: 480px; }
    }
    @media (max-width: 600px){
      #mapa{ height: 380px; }
      .chart{ height: 150px; }
      #chartCapital.chart{ height: 56px; }
    }

  footer {
    background-color: #8d7f7f;
    padding: 10px;
    text-align: center;
    color: white;
  }
  </style>
</head>
<body>
  <div class="page">
    <div class="headline">
      <h1>
        Regiones con la<br>
        <b>Brecha Salarial</b><br>
        <span class="accent"><b>Más Alta</b></span>
      </h1>
      <div class="desc">
        <p>La brecha salarial de género ha sido y sigue siendo uno de los temas más relevantes en el ámbito laboral del país. De acuerdo con CASEN 2022 (BCN, 2023), los hombres perciben en promedio un 16% más que las mujeres. A nivel regional, las diferencias son heterogéneas, con zonas que exhiben brechas muy superiores o inferiores al promedio nacional.</p>
      </div>
      <div class="desc">
        <p>Este proyecto busca visibilizar las diferencias territoriales en la brecha salarial de género (a favor de los hombres) y cómo existen patrones más definidos por zonas del país.</p>
      </div>
    </div>

    <!-- IZQUIERDA / DERECHA -->
    <div class="split">
      <!-- Columna izquierda -->
      <div class="left">
        <div id="mapa"></div>
      </div>

      <!-- Columna derecha -->
      <div class="right">

        <div class="sections">
          <div class="section" id="secDisparejos">
            <h3>Brechas más altas</h3>
            <hr>
            <div id="chartDisparejos" class="chart"></div>
          </div>

          <div class="section" id="secCapital">
            <h3>Brecha de la capital</h3>
            <hr>
            <div id="chartCapital" class="chart"></div>
          </div>

          <div class="section" id="secParejos">
            <h3>Brechas más bajas</h3>
            <hr>
            <div id="chartParejos" class="chart"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="info-box">
      <h4 id="region-name"></h4>
      <p id="region-info"></p>
    </div>
  </div>

  <footer>
  <p>Fuentes: <a href="https://www.bcn.cl/asesoriasparlamentarias/detalle_documento.html?id=82907">Biblioteca del Congreso Nacional de Chile</a> - <a href="https://www.ine.gob.cl/estadisticas/sociales/ingresos-y-gastos/encuesta-suplementaria-de-ingresos"> INE: Encuesta Suplementaria de Ingresos</a></p>
  <p>Desarrollado por: Xavier Morales, Fernando Navia e Ignacio Schatzke</p>
  </footer>

  <!-- Tu JS existente para dibujar mapa y barras puede ir aquí -->
  <!-- Plotly.newPlot('mapa', ...) y buildStackedBars('chartDisparejos', ...), etc. -->

</body>
</html>

  <script>
    // ====================
    // Utilidades BARRAS
    // ====================
    const MAXIMO = 40; // límite superior visual
    function buildStackedBars(divId, regiones, valores){
      const relleno = valores.map(v => Math.max(0, MAXIMO - v));

      const traceValor = {
        x: valores,
        y: regiones,
        type: 'bar',
        orientation: 'h',
        marker: {
          color: valores.map(v => {
            if (v >= 30) return '#b30000';
            if (v >= 25) return '#d7301f';
            if (v >= 20) return '#ef6548';
            if (v >= 15) return '#fc8d59';
            if (v >= 10) return '#fdbb84';
            return '#fdd49e';
          })
        },
        hovertemplate: '%{y}: %{x:.1f}%<extra></extra>',
        showlegend: false
      };

      const traceRelleno = {
        x: relleno,
        y: regiones,
        type: 'bar',
        orientation: 'h',
        marker: { color: 'rgba(0,0,0,0.15)' },
        text: valores.map(v => '<b>' + v.toFixed(1) + '%</b>' ),
        textposition: 'inside',
        insidetextanchor: 'middle',
        textfont: { color: '#111827', size: 12 },
        hoverinfo: 'skip',
        showlegend: false
      };

      const layout = {
        barmode: 'stack',
        bargap: 0.5,
        bargroupgap: 0.3,
        xaxis: {
          range: [0, MAXIMO],
          showticklabels: false,
          ticks: '',
          showgrid: false,
          zeroline: false
        },
        yaxis: {
          automargin: true,
          ticks: '',
          tickfont: { size: 14 }
        },
        margin: { l: 180, r: 20, t: 8, b: 8 },
        paper_bgcolor: '#EDEDED',
        plot_bgcolor: '#EDEDED',
        showlegend: false
      };

      Plotly.newPlot(divId, [traceValor, traceRelleno], layout, {staticPlot: true});
    }

    // ====================
    // Datos por sección
    // ====================
    // 3 más disparejos (orden: Antofagasta, Atacama, Magallanes)
    const regDisparejos = ['<b>3°</b>     Magallanes ', '<b>2°</b>        Atacama ', '<b>1°</b>   Antofagasta '];
    const valDisparejos = [24.3, 29.2, 33.9];

    // Capital
    const regCapital = ['<b>11°</b> Metropolitana '];
    const valCapital = [16.7];

    // 3 más parejos (orden: Araucanía, Maule, Ñuble)
    const regParejos = ['<b>15°</b>            Ñuble ', '<b>14°</b>            Maule ', '<b>13°</b>      Araucanía '];
    const valParejos = [4.8, 9.1, 11.8];

    // Render de las tres secciones
    buildStackedBars('chartDisparejos', regDisparejos, valDisparejos);
    buildStackedBars('chartCapital', regCapital, valCapital);
    buildStackedBars('chartParejos', regParejos, valParejos);

    // ====================
    // MAPA
    // ====================
    const geojson_url = "https://raw.githubusercontent.com/caracena/chile-geojson/master/regiones.json";

    d3.json(geojson_url).then(function(geojson) {
      // geojson.features.forEach(x => {
      //   if (x.properties.Region.startsWith("Región del ")) {
      //     x.properties.Region = x.properties.Region.slice(11);
      //   } else {
      //     x.properties.Region = x.properties.Region.slice(10);
      //   }
      // });

      const locations = geojson.features.map(f => f.properties.Region);
      const z = [20, 23.6, 33.9, 24.3, 18.1, 29.2, 19.5, 20, 16.7, 19.4, 16.7, 11.8, 20, 4.8, 9.1, 15.2];
      const info_regiones = locations.map((region) => {
        return {
          id: region,
          info: "ola aca va a ir la info"
        }
      })
      // -------------------------------------------------------------------
      // Aca se pone la info de cada region
      info_regiones[0].info = "Mediana ingreso del trabajo: H -> $500.000 M -> $400.000";
      info_regiones[1].info = "zana gei";
      // info_regiones[2].info = "algo";
      // info_regiones[3].info = "algo";
      // info_regiones[4].info = "algo";
      // info_regiones[5].info = "algo";
      // info_regiones[6].info = "algo";
      // info_regiones[7].info = "algo";
      // info_regiones[8].info = "algo";
      // info_regiones[9].info = "algo";
      // info_regiones[10].info = "algo";
      // info_regiones[11].info = "algo";
      // info_regiones[12].info = "algo";
      // info_regiones[13].info = "algo";
      // info_regiones[14].info = "algo";
      // info_regiones[15].info = "algo";
      // -------------------------------------------------------------------
      
      const breaks = [5, 10, 15, 20, 25, 30, 35];
      const colors = ['#fdd49e', '#fdbb84', '#fc8d59', '#ef6548', '#d7301f', '#b30000'];

      function steppedColorscale(breaks, colors) {
        const zmin = breaks[0], zmax = breaks[breaks.length - 1];
        const scale = [];
        for (let i = 0; i < colors.length; i++) {
          const v0 = breaks[i], v1 = breaks[i + 1];
          const t0 = (v0 - zmin) / (zmax - zmin);
          const t1 = (v1 - zmin) / (zmax - zmin);
          scale.push([t0, colors[i]]);
          scale.push([t1, colors[i]]);
        }
        return scale;
      }

      const colorscale = steppedColorscale(breaks, colors);

      var data = [{
        type: 'choropleth',
        geojson: geojson,
        locations: locations,
        z: z,
        featureidkey: 'properties.Region',
        zmin: 5,
        zmax: 35,
        colorscale: colorscale,
        marker: { line: { color: 'black', width: 0.2 } },
        // ↓ dejamos la escala activa, pero la movemos debajo del mapa
        colorbar: {
          orientation: 'h',
          x: 0.5, xanchor: 'center',
          y: -0.08, yanchor: 'bottom',   // << debajo del mapa
          title: { text: "Brecha Salarial (%)", side: "top" },
          len: 0.6, thickness: 15,
          tickmode: 'array',
          tickvals: [7.5, 12.5, 17.5, 22.5, 27.5, 32.5],
          ticktext: ['5-10', '10-15', '15-20', '20-25', '25-30', '30-35']
        },
        hoverinfo: 'none'
      }];

      var layout = {
        margin: { t: 0, b: 60, l: 0, r: 0 }, // más bottom para que quepa la escala
        paper_bgcolor: '#EDEDED',
        geo: {
          scope: 'south america',
          center: { lon: -70, lat: -40 },
          projection: { type: 'mercator', scale: 1.7 },
          showland: false,
          landcolor: 'lightgray',
          showcountries: true,
          countrycolor: '#EDEDED',
          bgcolor: '#EDEDED'
        },
        dragmode: false,
        scrollZoom: false,
        doubleClick: false,
        annotations: [
          {
            x: 0.5, y: 1.15,
            xref: 'paper', yref: 'paper',
            text: 'Este proyecto busca visibilizar las diferencias territoriales en la brecha salarial de género y cómo existen patrones más definidos por zonas del país.',
            showarrow: false,
            font: { size: 14, color: '#111827' },
            align: 'center',
            bgcolor: 'rgba(255,255,255,0.0)',
            borderpad: 4
          },
          {
            x: 0.51, y: 0.86,
            xref: 'paper', yref: 'paper',
            ax: 170, ay: 0,
            text: 'La región de <b>Antofagasta</b> presenta la <br>mayor diferencia, alcanzando<br>un <b>33,9%</b>, debido a la alta presencia <br> de sectores mineros extractivos,<br> altamente masculinizados y<br>de altos salarios',
            showarrow: true,
            font: { size: 12, color: 'black' },
            bgcolor: '#EDEDED',
            bordercolor: 'black',
            borderwidth: 1,
            borderpad: 5,
            arrowhead: 0,
            arrowwidth: 1,
            arrowcolor: 'black'
          },
          {
            x: 0.48, y: 0.58,
            xref: 'paper', yref: 'paper',
            ax: -170, ay: 0,
            text: 'La Región de <b>Ñuble</b><br>registra la menor<br>brecha <b>(4,8%)</b>, lo cual se <br>debe a que esta es una de las <br>regiones con los salarios más <br> bajos en Chile, disminuyendo <br>las diferencias entre <br> hombres y mujeres, además <br>de no tener trabajos <br> altamente masculinizados <br>como minería o finanzas.',
            showarrow: true,
            font: { size: 12, color: 'black' },
            bgcolor: '#EDEDED',
            bordercolor: 'black',
            borderwidth: 1,
            borderpad: 5,
            arrowhead: 0,
            arrowwidth: 1,
            arrowcolor: 'black'
          }
        ]
      };

      Plotly.newPlot('mapa', data, layout, { displayModeBar: false });

      selectedRegion = null;
      document.getElementById("mapa").on("plotly_click", function (data) {
        console.log(data.points[0]);
        const region = data.points[0].location;
        const brecha = data.points[0].z;
        const region_info = info_regiones.find((reg) => reg.id == region);
        console.log("clickeaste: ", region);
        change_info(region_info, brecha);

        if (selectedRegion === region) {
          selectedRegion = null;
        } else {
          selectedRegion = region;
        }

        // var newLineColors = locations.map(loc =>
        //   loc === selectedRegion ? 'white' : 'black'  // borde negro si está seleccionada
        // );
        var newLineWidths = locations.map(loc =>
          loc === selectedRegion ? 2 : 0.2  // más grueso si está seleccionada
        );

        // Actualizamos el gráfico
        Plotly.restyle('mapa', {
          // 'marker.line.color': [newLineColors],
          'marker.line.width': [newLineWidths]
        });

      });
    });

    function change_info(region_info, brecha) {
      if (region_info) {
        document.getElementById("region-name").innerText = region_info.id;
        document.getElementById("region-info").innerText = region_info.info;
        document.getElementById("info-box").style.display = "block";
        setTimeout(function () {
          document.getElementById("info-box").classList.add("visible");
        }, 1000);

      }
    }
  </script>
</body>
</html>
