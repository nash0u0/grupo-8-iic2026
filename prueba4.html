<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Brecha Salarial por Región</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <style>
    :root{
      --accent: #b30000;
      --text-main: #111827;
      --bg: #ffffff;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    *{ box-sizing: border-box; }
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      margin: 0;
    }
    .page{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .headline{
      text-align: center;
      margin: 8px 0 16px;
      line-height: 1.12;
    }
    .headline h1{
      margin: 0;
      font-size: clamp(28px, 5vw, 44px);
      font-weight: 150;
      color: var(--text-main);
    }
    .headline h1 b{ font-weight: 600; }
    .headline .accent{ color: var(--accent); }

    /* === SPLIT IZQUIERDA / DERECHA === */
    .split{
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }
    .left{ flex: 1 1 58%; min-width: 0; }
    .right{ flex: 1 1 42%; min-width: 0; }

    /* Contenido específico */
    #mapa{
      width: 100%;
      height: 600px;
      background: var(--bg);
      border-radius: 8px;
    }
    .desc{
      padding: 8px 12px 0 12px;
      text-align: justify;
      font-size: clamp(14px, 1.6vw, 18px);
      line-height: 1.55;
      color: #374151;
    }
    .desc p{ margin: 0 0 10px; }

    .sections{ margin-top: 18px; display: block; }
    .section{ margin: 18px 0; }
    .section h3{ margin: 0 0 6px; font-weight: 600; font-size: 18px; color: var(--text-main); }
    .section hr{ border: none; border-top: 1px solid #cfcfcf; }
    .chart{ height: 180px; background: var(--bg); border-radius: 6px; }
    #chartCapital.chart{ height: 70px; }

    /* === PANEL DE REGIÓN === */
    .info-panel{
      display:none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .info-panel h3{ margin: 0 0 6px; font-size: 20px; }
    .info-panel .subtitle{ margin: 0 0 12px; color: var(--muted); font-size: 13px; }
    .info-panel p{ margin: 0 0 12px; line-height: 1.5; }

    .data-table{
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .data-table th, .data-table td{ padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .y-label{ text-align: right; white-space: nowrap; width: 40%; color: #374151; }

    /* === Iconos de empleos destacados === */
    .jobs-grid{
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin: 6px 0 14px;
    }
    .job{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px;
      border-radius: 10px;
      background: var(--card);
    }
    .job img{
      width: 48px; height: 48px;
      object-fit: contain;
      /* si tus SVG son negros, puedes atenuarlos con filter si quieres */
      /* filter: grayscale(100%); */
    }
    .job figcaption{
      font-size: 12px;
      color: #374151;
      text-align: center;
      line-height: 1.2;
    }
    @media (max-width: 700px){
      .jobs-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    #panel-bar{ height: 220px; background: var(--bg); border-radius: 6px; margin-top: 6px; }

    .panel-actions{ display:flex; gap:8px; margin-top: 10px; }
    .btn{ cursor: pointer; border: 1px solid var(--border); background: #fff; padding: 6px 10px; border-radius: 8px; font-size: 13px; }
    .btn:hover{ background: #f3f4f6; }

    @media (max-width: 992px){
      .split{ flex-direction: column; }
      #mapa{ height: 480px; }
    }
    @media (max-width: 600px){
      #mapa{ height: 380px; }
      .chart{ height: 150px; }
      #panel-bar{ height: 200px; }
    }

    footer{ background-color: #8d7f7f; padding: 10px; text-align: center; color: white; }
  </style>
</head>
<body>
  <div class="page">
    <div class="headline">
      <h1>
        Regiones con la<br>
        <b>Brecha Salarial</b><br>
        <span class="accent"><b>Más Alta</b></span>
      </h1>
      <div class="desc">
        <p>La brecha salarial de género ha sido y sigue siendo uno de los temas más relevantes en el ámbito laboral del país. De acuerdo con CASEN 2022 (BCN, 2023), los hombres perciben en promedio un 16% más que las mujeres. A nivel regional, las diferencias son heterogéneas, con zonas que exhiben brechas muy superiores o inferiores al promedio nacional.</p>
      </div>
      <div class="desc">
        <p>Este proyecto busca visibilizar las diferencias territoriales en la brecha salarial de género (a favor de los hombres) y cómo existen patrones más definidos por zonas del país.</p>
      </div>
    </div>

    <div class="split">
      <div class="left">
        <div id="mapa"></div>
      </div>

      <div class="right">
        <!-- PANEL DINÁMICO -->
        <div id="info-panel" class="info-panel" role="region" aria-live="polite">
          <h3 id="panel-title">&nbsp;</h3>
          <div class="subtitle" id="panel-subtitle"></div>
          <p id="panel-text"></p>

          <!-- NUEVO: iconos de empleos -->
          <div id="panel-jobs" class="jobs-grid" aria-label="Empleos destacados"></div>

          <table class="data-table" id="panel-table">
            <tbody id="panel-tbody"></tbody>
          </table>

          <div id="panel-bar"></div>

          <div class="panel-actions">
            <button class="btn" id="panel-back">Volver</button>
          </div>
        </div>

        <!-- Contenido por defecto -->
        <div id="right-info" class="sections">
          <div class="section" id="secDisparejos">
            <h3>Brechas más altas</h3>
            <hr>
            <div id="chartDisparejos" class="chart"></div>
          </div>

          <div class="section" id="secCapital">
            <h3>Brecha de la capital</h3>
            <hr>
            <div id="chartCapital" class="chart"></div>
          </div>

          <div class="section" id="secParejos">
            <h3>Brechas más bajas</h3>
            <hr>
            <div id="chartParejos" class="chart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>Fuentes: <a href="https://www.bcn.cl/asesoriasparlamentarias/detalle_documento.html?id=82907">Biblioteca del Congreso Nacional de Chile</a> - <a href="https://www.ine.gob.cl/estadisticas/sociales/ingresos-y-gastos/encuesta-suplementaria-de-ingresos">INE: Encuesta Suplementaria de Ingresos</a></p>
    <p>Desarrollado por: Xavier Morales, Fernando Navia e Ignacio Schatzke</p>
  </footer>

  <script>
    // ====================
    // Utilidades BARRAS (listas)
    // ====================
    const MAXIMO = 40; // límite visual para los rankings
    function buildStackedBars(divId, regiones, valores){
      const relleno = valores.map(v => Math.max(0, MAXIMO - v));

      const traceValor = {
        x: valores,
        y: regiones,
        type: 'bar',
        orientation: 'h',
        marker: {
          color: valores.map(v => {
            if (v >= 30) return '#b30000';
            if (v >= 25) return '#d7301f';
            if (v >= 20) return '#ef6548';
            if (v >= 15) return '#fc8d59';
            if (v >= 10) return '#fdbb84';
            return '#fdd49e';
          })
        },
        hovertemplate: '{y}: {x}<extra></extra>',
        showlegend: false
      };

      const traceRelleno = {
        x: relleno,
        y: regiones,
        type: 'bar',
        orientation: 'h',
        marker: { color: 'rgba(0,0,0,0.15)' },
        text: valores.map(v => '<b>' + v.toFixed(1) + '%</b>' ),
        textposition: 'inside',
        insidetextanchor: 'middle',
        textfont: { color: '#111827', size: 12 },
        hoverinfo: 'skip',
        showlegend: false
      };

      const layout = {
        barmode: 'stack',
        bargap: 0.5,
        bargroupgap: 0.3,
        xaxis: { range: [0, MAXIMO], showticklabels: false, ticks: '', showgrid: false, zeroline: false },
        yaxis: { automargin: true, ticks: '', tickfont: { size: 14 } },
        margin: { l: 180, r: 20, t: 8, b: 8 },
        paper_bgcolor: '#ffffff',
        plot_bgcolor: '#ffffff',
        showlegend: false
      };

      Plotly.newPlot(divId, [traceValor, traceRelleno], layout, {staticPlot: true, responsive: true, displayModeBar: false});
    }

    // ====================
    // DATOS DE REGIONES + ALIAS (para empatar con el GeoJSON)
    // ====================
    const BRECHA_NACIONAL = 16.0;

    const REGIONES_DATA = {
      // Norte
      "Arica y Parinacota": {
        label: "Arica y Parinacota",
        brecha: 20.0, h: 500000, m: 400000,
        empleos: ["Administración pública", "Construcción", "Comercio"]
      },
      "Tarapacá": {
        label: "Tarapacá",
        brecha: 23.6, h: 550000, m: 420000,
        empleos: ["Comercio", "Enseñanza", "Transporte/almacenamiento"]
      },
      "Antofagasta": {
        label: "Antofagasta",
        brecha: 33.9, h: 700000, m: 462500,
        empleos: ["Minería", "Comercio", "Transporte/almacenamiento"]
      },
      "Atacama": {
        label: "Atacama",
        brecha: 29.2, h: 600000, m: 425000,
        empleos: ["Minería", "Comercio", "Industrias manufactureras"]
      },
      "Coquimbo": {
        label: "Coquimbo",
        brecha: 19.5, h: 500000, m: 402500,
        empleos: ["Comercio", "Minería", "Enseñanza"]
      },

      // Centro
      "Valparaíso": {
        label: "Valparaíso",
        brecha: 20.0, h: 500000, m: 400000,
        empleos: ["Comercio", "Construcción", "Transporte"]
      },
      "Metropolitana de Santiago": {
        label: "Metropolitana",
        brecha: 16.7, h: 600000, m: 500000,
        empleos: ["Comercio", "Construcción", "Industrias manufactureras"],
        aliases: ["Metropolitana", "Región Metropolitana"]
      },
      "Región del Libertador Bernardo O'Higgins": {
        label: "Libertador Bernardo O’Higgins",
        brecha: 15.2, h: 500000, m: 424167,
        empleos: ["Actividades silvoagropecuarias y pesca", "Comercio", "Industrias manufactureras"],
        aliases: ["O’Higgins", "Libertador Bernardo O’Higgins"]
      },
      "Maule": {
        label: "Maule",
        brecha: 9.1, h: 440000, m: 400000,
        empleos: ["Comercio", "Silvoagropecuarias y pesca", "Enseñanza"]
      },
      "Ñuble": {
        label: "Ñuble",
        brecha: 4.8, h: 420000, m: 400000,
        empleos: ["Comercio", "Silvoagropecuarias y pesca", "Industrias manufactureras"]
      },
      "Región del Bío-Bío": {
        label: "Región del Biobío",
        brecha: 20.0, h: 500000, m: 400000,
        empleos: ["Comercio", "Industrias manufactureras", "Enseñanza"]
      },

      // Sur
      "La Araucanía": {
        label: "La Araucanía",
        brecha: 11.8, h: 430744, m: 380000,
        empleos: ["Comercio", "Construcción", "Silvoagropecuarias y pesca"]
      },
      "Los Ríos": {
        label: "Los Ríos",
        brecha: 16.7, h: 480000, m: 400000,
        empleos: ["Comercio", "Silvoagropecuarias y pesca", "Enseñanza"]
      },
      "Los Lagos": {
        label: "Los Lagos",
        brecha: 19.4, h: 500000, m: 402917,
        empleos: ["Comercio", "Industrias manufactureras", "Silvoagropecuarias y pesca"]
      },

      // Austral
      "Aysén del General Carlos Ibáñez del Campo": {
        label: "Aysén",
        brecha: 18.1, h: 610834, m: 500000,
        empleos: ["Administración pública", "Comercio", "Construcción"],
        aliases: ["Aysén"]
      },
      "Magallanes y de la Antártica Chilena": {
        label: "Magallanes",
        brecha: 24.3, h: 668500, m: 506250,
        empleos: ["Comercio", "Administración pública", "Transporte"],
        aliases: ["Magallanes"]
      }
    };

    function canonicalKey(name) {
      if (REGIONES_DATA[name]) return name;
      for (const k in REGIONES_DATA) {
        const item = REGIONES_DATA[k];
        if (item.aliases && item.aliases.includes(name)) return k;
      }
      const soft = name
        .replace(/^Región\s+de\s+/i, "")
        .replace(/^Región\s+/i, "")
        .replace(/\s+/g, " ")
        .trim();
      for (const k in REGIONES_DATA) {
        if (k.includes(soft) || soft.includes(k)) return k;
        const lbl = REGIONES_DATA[k].label || "";
        if (lbl.includes(soft) || soft.includes(lbl)) return k;
      }
      return name;
    }

    // ====================
    // RANKINGS
    // ====================
    const regDisparejos = ['<b>3°</b> Magallanes ', '<b>2°</b> Atacama ', '<b>1°</b> Antofagasta '];
    const valDisparejos = [
      REGIONES_DATA["Magallanes y de la Antártica Chilena"].brecha,
      REGIONES_DATA["Atacama"].brecha,
      REGIONES_DATA["Antofagasta"].brecha
    ];
    const regCapital = ['Metropolitana '];
    const valCapital = [REGIONES_DATA["Metropolitana de Santiago"].brecha];
    const regParejos = ['<b>3°</b> La Araucanía ', '<b>2°</b> Maule ', '<b>1°</b> Ñuble '];
    const valParejos = [
      REGIONES_DATA["La Araucanía"].brecha,
      REGIONES_DATA["Maule"].brecha,
      REGIONES_DATA["Ñuble"].brecha
    ];
    buildStackedBars('chartDisparejos', regDisparejos, valDisparejos);
    buildStackedBars('chartCapital', regCapital, valCapital);
    buildStackedBars('chartParejos', regParejos, valParejos);

    // ====================
    // Utilidades del panel
    // ====================
    function showPanel(){
      document.getElementById('right-info').style.display = 'none';
      document.getElementById('info-panel').style.display = 'block';
    }
    function hidePanel(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('right-info').style.display = 'block';
      const pb = document.getElementById('panel-bar');
      if (pb) pb.innerHTML = '';
    }
    function buildInfoTable(tbodyId, rows){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = '';
      rows.forEach(([label, value]) => {
        const tr = document.createElement('tr');
        const tdY = document.createElement('td');
        const tdV = document.createElement('td');
        tdY.className = 'y-label';
        tdY.textContent = label;
        tdV.textContent = value;
        tr.appendChild(tdY);
        tr.appendChild(tdV);
        tb.appendChild(tr);
      });
    }

    // === ICONOS: mapeo nombre -> archivo SVG (placeholders en ./icons/) ===
    const ICONS_PATH = './icons';
    const employmentIconMap = {
      "Administración pública": "admin-publica.svg",
      "Construcción": "construccion.svg",
      "Comercio": "comercio.svg",
      "Enseñanza": "ensenanza.svg",
      "Transporte/almacenamiento": "transporte-almacenamiento.svg",
      "Transporte": "transporte-almacenamiento.svg",
      "Minería": "mineria.svg",
      "Industrias manufactureras": "industrias-manufactureras.svg",
      "Actividades silvoagropecuarias y pesca": "silvoagropecuarias-pesca.svg",
      "Silvoagropecuarias y pesca": "silvoagropecuarias-pesca.svg"
    };

    function renderJobs(empleos){
      const grid = document.getElementById('panel-jobs');
      grid.innerHTML = '';
      (empleos || []).forEach(nombre => {
        const file = employmentIconMap[nombre] || 'placeholder.svg';
        const fig = document.createElement('figure');
        fig.className = 'job';

        const img = document.createElement('img');
        img.src = `${ICONS_PATH}/${file}`;
        img.alt = nombre;
        img.loading = 'lazy';

        const cap = document.createElement('figcaption');
        cap.textContent = nombre;

        fig.appendChild(img);
        fig.appendChild(cap);
        grid.appendChild(fig);
      });
    }

    // ====================
    // Barras del panel: eje Y fijo en $1.000.000 y hover -> negro
    // ====================
    function renderRegionBars(regionName, brecha){
      const container = 'panel-bar';
      const k = Object.keys(REGIONES_DATA).find(
        key => REGIONES_DATA[key].label === regionName
      ) || canonicalKey(regionName);
      const data = REGIONES_DATA[k];

      const isMoney = !!data;
      const x = isMoney ? ["Hombres", "Mujeres"] : [regionName, "Nacional"];
      const y = isMoney ? [data.h, data.m] : [brecha, BRECHA_NACIONAL];

      const baseColors = ['#b30000', '#ef6548'];

      const trace = {
        x, y, type: 'bar',
        marker: { color: baseColors.slice() },
        text: y.map(v => isMoney
          ? `$${Number(v ?? 0).toLocaleString("es-CL")}`
          : `${(v ?? 0).toFixed(1)}%`
        ),
        textposition: 'auto',
        hovertemplate: isMoney
          ? '%{x}: <b>$%{y:,}</b><extra></extra>'
          : '%{x}: <b>%{y:.1f}%</b><extra></extra>',
      };

      const layout = {
        title: { text: isMoney ? `Medianas de ingreso — ${regionName}` : 'Brecha Regional vs. Nacional', font: { size: 14 } },
        margin: { t: 30, r: 10, l: 40, b: 40 },
        paper_bgcolor: '#ffffff',
        plot_bgcolor: '#ffffff',
        dragmode: false,
        xaxis: { tickangle: -10 },
        yaxis: isMoney
          ? { range: [0, 1_000_000], tickformat: '$~s', fixedrange: true }
          : { rangemode: 'tozero', fixedrange: true },
      };

      Plotly.newPlot(container, [trace], layout, { displayModeBar: false, responsive: true })
        .then(gd => {
          const original = baseColors.slice();
          gd.on('plotly_hover', (ev) => {
            const i = ev.points?.[0]?.pointNumber;
            if (i == null) return;
            const newColors = original.slice();
            newColors[i] = '#000000';
            Plotly.restyle(gd, { 'marker.color': [newColors] });
          });
          gd.on('plotly_unhover', () => {
            Plotly.restyle(gd, { 'marker.color': [original] });
          });
        });
    }

    function renderRegionPanel(regionName, brecha){
      const k = canonicalKey(regionName);
      const data = REGIONES_DATA[k];

      const title = data ? data.label : regionName;
      const text = data
        ? `Empleos destacados en la región.`
        : 'Descripción pendiente para esta región.';
      const rows = data
        ? [
          ]
        : [['Brecha salarial', `${(typeof brecha === 'number') ? brecha.toFixed(1) : brecha}`]];

      document.getElementById('panel-title').textContent = title;
      document.getElementById('panel-subtitle').textContent =
        `Brecha estimada: ${(data?.brecha ?? brecha).toFixed ? (data?.brecha ?? brecha).toFixed(1) : brecha}%`;
      document.getElementById('panel-text').textContent = text;

      // Renderizar iconos de empleos con subtítulo
      renderJobs(data?.empleos || []);

      buildInfoTable('panel-tbody', rows);
      showPanel();
      renderRegionBars(title, data?.brecha ?? (typeof brecha === 'number' ? brecha : BRECHA_NACIONAL));
    }

    // ====================
    // MAPA + interacción
    // ====================
    const geojson_url = "https://raw.githubusercontent.com/caracena/chile-geojson/master/regiones.json";

    d3.json(geojson_url).then(function(geojson) {
      const locations = geojson.features.map(f => f.properties.Region);

      // z desde nuestros datos, usando canonicalKey para empatar nombres
      const z = locations.map(loc => {
        const k = canonicalKey(loc);
        return REGIONES_DATA[k]?.brecha ?? null;
      });

      const breaks = [5, 10, 15, 20, 25, 30, 35];
      const colors = ['#fdd49e', '#fdbb84', '#fc8d59', '#ef6548', '#d7301f', '#b30000'];
      const colorscale = (function steppedColorscale(breaks, colors) {
        const zmin = breaks[0], zmax = breaks[breaks.length - 1];
        const scale = [];
        for (let i = 0; i < colors.length; i++) {
          const v0 = breaks[i], v1 = breaks[i + 1];
          const t0 = (v0 - zmin) / (zmax - zmin);
          const t1 = (v1 - zmin) / (zmax - zmin);
          scale.push([t0, colors[i]]);
          scale.push([t1, colors[i]]);
        }
        return scale;
      })(breaks, colors);

      const data = [{
        type: 'choropleth',
        geojson: geojson,
        locations: locations,
        z: z,
        featureidkey: 'properties.Region',
        zmin: 5,
        zmax: 35,
        colorscale: colorscale,
        marker: { line: { color: 'black', width: 0.2 } },
        colorbar: {
          orientation: 'h', x: 0.5, xanchor: 'center', y: -0.08, yanchor: 'bottom',
          title: { text: 'Brecha Salarial (%)', side: 'top' }, len: 0.6, thickness: 15,
          tickmode: 'array', tickvals: [7.5, 12.5, 17.5, 22.5, 27.5, 32.5],
          ticktext: ['5-10', '10-15', '15-20', '20-25', '25-30', '30-35']
        },
        hoverinfo: 'none'
      }];

      const layout = {
        margin: { t: 0, b: 60, l: 0, r: 0 },
        paper_bgcolor: '#ffffff',
        geo: {
          scope: 'south america',
          center: { lon: -70, lat: -40 },
          projection: { type: 'mercator', scale: 1.7 },
          showland: false,
          showcountries: true,
          countrycolor: '#ffffff',
          bgcolor: '#ffffff'
        },
        dragmode: false, scrollZoom: false, doubleClick: false
      };

      Plotly.newPlot('mapa', data, layout, { displayModeBar: false, responsive: true });

      let selectedRegion = null;
      document.getElementById('mapa').on('plotly_click', function (ev) {
        const region = ev.points?.[0]?.location;
        const brecha = ev.points?.[0]?.z;
        if(!region) return;

        if (selectedRegion === region){
          selectedRegion = null;
          Plotly.restyle('mapa', { 'marker.line.width': [[0.2]] });
          hidePanel();
          return;
        }

        selectedRegion = region;
        const newLineWidths = locations.map(loc => loc === selectedRegion ? 2 : 0.2);
        Plotly.restyle('mapa', { 'marker.line.width': [newLineWidths] });
        renderRegionPanel(region, brecha);
      });

      document.getElementById('panel-back').addEventListener('click', () => {
        selectedRegion = null;
        Plotly.restyle('mapa', { 'marker.line.width': [[0.2]] });
        hidePanel();
      });
    });
  </script>
</body>
</html>
