<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Brecha Salarial por Región</title>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <style>
    :root{
      --accent: #b30000;
      --text-main: #111827;
      --bg: #EDEDED;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    *{ box-sizing: border-box; }
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      margin: 0;
    }
    .page{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .headline{
      text-align: center;
      margin: 8px 0 16px;
      line-height: 1.12;
    }
    .headline h1{
      margin: 0;
      font-size: clamp(28px, 5vw, 44px);
      font-weight: 150;
      color: var(--text-main);
    }
    .headline h1 b{ font-weight: 600; }
    .headline .accent{ color: var(--accent); }

    /* === SPLIT IZQUIERDA / DERECHA === */
    .split{
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }
    .left{ flex: 1 1 58%; min-width: 0; }
    .right{ flex: 1 1 42%; min-width: 0; }

    /* Contenido específico */
    #mapa{
      width: 100%;
      height: 600px;
      background: var(--bg);
      border-radius: 8px;
    }
    .desc{
      padding: 8px 12px 0 12px;
      text-align: justify;
      font-size: clamp(14px, 1.6vw, 18px);
      line-height: 1.55;
      color: #374151;
    }
    .desc p{ margin: 0 0 10px; }

    .sections{ margin-top: 18px; display: block; }
    .section{ margin: 18px 0; }
    .section h3{ margin: 0 0 6px; font-weight: 600; font-size: 18px; color: var(--text-main); }
    .section hr{ border: none; border-top: 1px solid #cfcfcf; }
    .chart{ height: 180px; background: var(--bg); border-radius: 6px; }
    #chartCapital.chart{ height: 70px; }

    /* === PANEL DE REGIÓN (Plantilla) === */
    .info-panel{
      display:none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .info-panel h3{ margin: 0 0 6px; font-size: 20px; }
    .info-panel .subtitle{ margin: 0 0 12px; color: var(--muted); font-size: 13px; }
    .info-panel p{ margin: 0 0 12px; line-height: 1.5; }

    .data-table{
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .data-table caption{
      text-align: left; font-weight: 600; padding: 8px 10px; background: #f9fafb; border-bottom: 1px solid var(--border);
    }
    .data-table th, .data-table td{ padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .data-table th{ text-align: left; font-weight: 600; color: var(--muted); }
    .data-table tr:nth-child(even){ background: #fafafa; }
    /* Emular "eje Y": etiquetas alineadas a la derecha */
    .y-label{ text-align: right; white-space: nowrap; width: 40%; color: #374151; }

    /* Contenedor del gráfico dentro del panel */
    #panel-bar{ height: 220px; background: var(--bg); border-radius: 6px; margin-top: 10px; }

    .panel-actions{ display:flex; gap:8px; margin-top: 10px; }
    .btn{ cursor: pointer; border: 1px solid var(--border); background: #fff; padding: 6px 10px; border-radius: 8px; font-size: 13px; }
    .btn:hover{ background: #f3f4f6; }

    @media (max-width: 992px){
      .split{ flex-direction: column; }
      #mapa{ height: 480px; }
    }
    @media (max-width: 600px){
      #mapa{ height: 380px; }
      .chart{ height: 150px; }
      #chartCapital.chart{ height: 56px; }
      #panel-bar{ height: 200px; }
    }

    footer{ background-color: #8d7f7f; padding: 10px; text-align: center; color: white; }
  </style>
</head>
<body>
  <div class="page">
    <div class="headline">
      <h1>
        Regiones con la<br>
        <b>Brecha Salarial</b><br>
        <span class="accent"><b>Más Alta</b></span>
      </h1>
      <div class="desc">
        <p>La brecha salarial de género ha sido y sigue siendo uno de los temas más relevantes en el ámbito laboral del país. De acuerdo con CASEN 2022 (BCN, 2023), los hombres perciben en promedio un 16% más que las mujeres. A nivel regional, las diferencias son heterogéneas, con zonas que exhiben brechas muy superiores o inferiores al promedio nacional.</p>
      </div>
      <div class="desc">
        <p>Este proyecto busca visibilizar las diferencias territoriales en la brecha salarial de género (a favor de los hombres) y cómo existen patrones más definidos por zonas del país.</p>
      </div>
    </div>

    <!-- IZQUIERDA / DERECHA -->
    <div class="split">
      <!-- Columna izquierda -->
      <div class="left">
        <div id="mapa"></div>
      </div>

      <!-- Columna derecha -->
      <div class="right">
        <!-- PANEL DINÁMICO -->
        <div id="info-panel" class="info-panel" role="region" aria-live="polite">
          <h3 id="panel-title">&nbsp;</h3>
          <div class="subtitle" id="panel-subtitle"></div>
          <p id="panel-text"></p>
          <table class="data-table" id="panel-table">
            <caption id="panel-table-caption">Indicadores</caption>
            <tbody id="panel-tbody"><!-- filas dinámicas --></tbody>
          </table>

          <!-- NUEVO: gráfico de barras al seleccionar región -->
          <div id="panel-bar"></div>

          <div class="panel-actions">
            <button class="btn" id="panel-back">Volver</button>
          </div>
        </div>

        <!-- Contenido por defecto cuando no hay región seleccionada -->
        <div id="right-info" class="sections">
          <div class="section" id="secDisparejos">
            <h3>Brechas más altas</h3>
            <hr>
            <div id="chartDisparejos" class="chart"></div>
          </div>

          <div class="section" id="secCapital">
            <h3>Brecha de la capital</h3>
            <hr>
            <div id="chartCapital" class="chart"></div>
          </div>

          <div class="section" id="secParejos">
            <h3>Brechas más bajas</h3>
            <hr>
            <div id="chartParejos" class="chart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>Fuentes: <a href="https://www.bcn.cl/asesoriasparlamentarias/detalle_documento.html?id=82907">Biblioteca del Congreso Nacional de Chile</a> - <a href="https://www.ine.gob.cl/estadisticas/sociales/ingresos-y-gastos/encuesta-suplementaria-de-ingresos">INE: Encuesta Suplementaria de Ingresos</a></p>
    <p>Desarrollado por: Xavier Morales, Fernando Navia e Ignacio Schatzke</p>
  </footer>

  <script>
    // ====================
    // Utilidades BARRAS (listas)
    // ====================
    const MAXIMO = 40; // límite superior visual
    function buildStackedBars(divId, regiones, valores){
      const relleno = valores.map(v => Math.max(0, MAXIMO - v));

      const traceValor = {
        x: valores,
        y: regiones,
        type: 'bar',
        orientation: 'h',
        marker: {
          color: valores.map(v => {
            if (v >= 30) return '#b30000';
            if (v >= 25) return '#d7301f';
            if (v >= 20) return '#ef6548';
            if (v >= 15) return '#fc8d59';
            if (v >= 10) return '#fdbb84';
            return '#fdd49e';
          })
        },
        hovertemplate: '{y}: {x}<extra></extra>',
        showlegend: false
      };

      const traceRelleno = {
        x: relleno,
        y: regiones,
        type: 'bar',
        orientation: 'h',
        marker: { color: 'rgba(0,0,0,0.15)' },
        text: valores.map(v => '<b>' + v.toFixed(1) + '</b>' ),
        textposition: 'inside',
        insidetextanchor: 'middle',
        textfont: { color: '#111827', size: 12 },
        hoverinfo: 'skip',
        showlegend: false
      };

      const layout = {
        barmode: 'stack',
        bargap: 0.5,
        bargroupgap: 0.3,
        xaxis: { range: [0, MAXIMO], showticklabels: false, ticks: '', showgrid: false, zeroline: false },
        yaxis: { automargin: true, ticks: '', tickfont: { size: 14 } },
        margin: { l: 180, r: 20, t: 8, b: 8 },
        paper_bgcolor: '#EDEDED',
        plot_bgcolor: '#EDEDED',
        showlegend: false
      };

      Plotly.newPlot(divId, [traceValor, traceRelleno], layout, {staticPlot: true, responsive: true, displayModeBar: false});
    }

    // ====================
    // NUEVO: Datos para barras del panel por región
    // ====================
    // Si hay datos específicos por región, úsalos.
    // Si no, se grafica comparación "Región vs Nacional (16%)".
    const BRECHA_NACIONAL = 16.0;

    const regionBars = {
      // Ejemplos (ajusta a tus datos reales)
      'Región de Antofagasta': {
        title: 'Composición sectorial del empleo',
        categories: ['Hombres', 'Mujeres'],
        values: [700000, 462500]
      },
      'Región de Ñuble': {
        title: 'Composición sectorial del empleo (%)',
        categories: ['Hombres', 'Mujeres'],
        values: [28, 15, 45, 12]
      }
      // Agrega más regiones si tienes desgloses
    };

    function renderRegionBars(regionName, brecha){
      const container = 'panel-bar';
      let title, x, y;
      console.log(regionName);
      console.log(regionBars);

      if (regionBars[regionName]){
        title = regionBars[regionName].title || `Indicadores de ${regionName}`;
        x = regionBars[regionName].categories;
        y = regionBars[regionName].values;
      } else {
        // fallback: comparación región vs nacional
        title = 'Brecha Regional vs. Nacional';
        x = [regionName, 'Nacional'];
        y = [brecha, BRECHA_NACIONAL];
      }

      const trace = {
        x, y,
        type: 'bar',
        text: y.map(v => (v!=null && !isNaN(v)) ? `${v.toFixed(1)}` : ''),
        textposition: 'auto',
        hovertemplate: '{x}: {y}<extra></extra>',
        marker: { color: ['#b30000', '#ef6548', '#fc8d59', '#fdbb84', '#fdd49e'] },
        hoverinfo: 'none'
      };

      const layout = {
        title: { text: title, font: { size: 14 } },
        margin: { t: 30, r: 10, l: 40, b: 40 },
        paper_bgcolor: '#EDEDED',
        plot_bgcolor: '#EDEDED',
        yaxis: { rangemode: 'tozero', gridcolor: 'rgba(0,0,0,0.08)' },
        xaxis: { tickangle: -20 }
      };

      Plotly.newPlot(container, [trace], layout, {displayModeBar: false, responsive: true});
    }

    // ====================
    // Datos por sección (ejemplo)
    // ====================
    const regDisparejos = ['<b>3°</b>     Magallanes ', '<b>2°</b>        Atacama ', '<b>1°</b>   Antofagasta '];
    const valDisparejos = [24.3, 29.2, 33.9];
    const regCapital = ['<b>11°</b> Metropolitana '];
    const valCapital = [16.7];
    const regParejos = ['<b>15°</b>            Ñuble ', '<b>14°</b>            Maule ', '<b>13°</b>      Araucanía '];
    const valParejos = [4.8, 9.1, 11.8];

    buildStackedBars('chartDisparejos', regDisparejos, valDisparejos);
    buildStackedBars('chartCapital', regCapital, valCapital);
    buildStackedBars('chartParejos', regParejos, valParejos);

    // ====================
    // MAPA
    // ====================
    const geojson_url = "https://raw.githubusercontent.com/caracena/chile-geojson/master/regiones.json";

    // Dataset de ejemplo para el panel por región
    // Estructura: { [Region]: { title, text, rows: [[label, valor], ...] } }
    const regionMeta = {
      'Antofagasta': {
        title: 'Antofagasta',
        text: 'Alta presencia de minería y sectores altamente masculinizados con salarios elevados. Esto amplifica la diferencia de ingresos entre hombres y mujeres.',
        rows: [
          ['Brecha salarial', '33,9%'],
          ['Mediana ingreso (H)', '$500.000'],
          ['Mediana ingreso (M)', '$400.000'],
          ['Participación minera', '31% empleo rel. sectorial*']
        ]
      },
      'Ñuble': {
        title: 'Ñuble',
        text: 'Estructura productiva con menor peso de sectores de alta remuneración masculinizados; salarios más bajos y con menor dispersión reducen la brecha observada.',
        rows: [
          ['Brecha salarial', '4,8%'],
          ['Mediana ingreso (H)', '$380.000'],
          ['Mediana ingreso (M)', '$362.000'],
          ['Sector dominante', 'Agro / servicios locales']
        ]
      }
      // Agrega más regiones aquí según tus datos
    };

    // Paleta discreta escalonada
    const breaks = [5, 10, 15, 20, 25, 30, 35];
    const colors = ['#fdd49e', '#fdbb84', '#fc8d59', '#ef6548', '#d7301f', '#b30000'];
    const colorscale = (function steppedColorscale(breaks, colors) {
      const zmin = breaks[0], zmax = breaks[breaks.length - 1];
      const scale = [];
      for (let i = 0; i < colors.length; i++) {
        const v0 = breaks[i], v1 = breaks[i + 1];
        const t0 = (v0 - zmin) / (zmax - zmin);
        const t1 = (v1 - zmin) / (zmax - zmin);
        scale.push([t0, colors[i]]);
        scale.push([t1, colors[i]]);
      }
      return scale;
    })(breaks, colors);

    // Utilidades del panel
    function showPanel(){
      document.getElementById('right-info').style.display = 'none';
      document.getElementById('info-panel').style.display = 'block';
    }
    function hidePanel(){
      document.getElementById('info-panel').style.display = 'none';
      document.getElementById('right-info').style.display = 'block';
      // limpiar gráfico para evitar flashes al volver
      const pb = document.getElementById('panel-bar');
      if (pb) pb.innerHTML = '';
    }
    function buildInfoTable(tbodyId, rows){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = '';
      rows.forEach(([label, value]) => {
        const tr = document.createElement('tr');
        const tdY = document.createElement('td');
        const tdV = document.createElement('td');
        tdY.className = 'y-label';
        tdY.textContent = label;
        tdV.textContent = value;
        tr.appendChild(tdY);
        tr.appendChild(tdV);
        tb.appendChild(tr);
      });
    }
    function renderRegionPanel(regionName, brecha){
      const meta = regionMeta[regionName] || {
        title: regionName,
        text: 'Descripción pendiente para esta región. Puedes completar este texto con el contexto productivo local o notas del reporte.',
        rows: [['Brecha salarial', `${brecha?.toFixed ? brecha.toFixed(1) : brecha}`]]
      };
      document.getElementById('panel-title').textContent = meta.title;
      document.getElementById('panel-subtitle').textContent = `Brecha estimada: ${brecha?.toFixed ? brecha.toFixed(1) : brecha}`;
      document.getElementById('panel-text').textContent = meta.text;
      document.getElementById('panel-table-caption').textContent = 'Indicadores';
      buildInfoTable('panel-tbody', meta.rows);

      // NUEVO: dibujar el gráfico de barras del panel
      renderRegionBars(regionName, (typeof brecha === 'number') ? brecha : BRECHA_NACIONAL);

      showPanel();
    }

    // Mapa + interacción
    d3.json(geojson_url).then(function(geojson) {
      const locations = geojson.features.map(f => f.properties.Region);
      // z: demo; sustituye con tus valores por región en el mismo orden que "locations"
      const z = [20, 23.6, 33.9, 24.3, 18.1, 29.2, 19.5, 20, 16.7, 19.4, 16.7, 11.8, 20, 4.8, 9.1, 15.2];

      const data = [{
        type: 'choropleth',
        geojson: geojson,
        locations: locations,
        z: z,
        featureidkey: 'properties.Region',
        zmin: 5,
        zmax: 35,
        colorscale: colorscale,
        marker: { line: { color: 'black', width: 0.2 } },
        colorbar: {
          orientation: 'h', x: 0.5, xanchor: 'center', y: -0.08, yanchor: 'bottom',
          title: { text: 'Brecha Salarial (%)', side: 'top' }, len: 0.6, thickness: 15,
          tickmode: 'array', tickvals: [7.5, 12.5, 17.5, 22.5, 27.5, 32.5],
          ticktext: ['5-10', '10-15', '15-20', '20-25', '25-30', '30-35']
        },
        hoverinfo: 'none'
      }];

      const layout = {
        margin: { t: 0, b: 60, l: 0, r: 0 },
        paper_bgcolor: '#EDEDED',
        geo: {
          scope: 'south america', center: { lon: -70, lat: -40 }, projection: { type: 'mercator', scale: 1.7 },
          showland: false, landcolor: 'lightgray', showcountries: true, countrycolor: '#EDEDED', bgcolor: '#EDEDED'
        },
        dragmode: false, scrollZoom: false, doubleClick: false
      };

      Plotly.newPlot('mapa', data, layout, { displayModeBar: false, responsive: true });

      let selectedRegion = null;
      document.getElementById('mapa').on('plotly_click', function (ev) {
        const region = ev.points?.[0]?.location;
        const brecha = ev.points?.[0]?.z;
        if(!region) return;

        if (selectedRegion === region){
          // deseleccionar
          selectedRegion = null;
          Plotly.restyle('mapa', { 'marker.line.width': [[0.2]] });
          hidePanel();
          return;
        }

        selectedRegion = region;
        // resaltar borde
        const newLineWidths = locations.map(loc => loc === selectedRegion ? 2 : 0.2);
        Plotly.restyle('mapa', { 'marker.line.width': [newLineWidths] });
        // Renderizar panel
        renderRegionPanel(region, brecha);
      });

      // Botón volver
      document.getElementById('panel-back').addEventListener('click', () => {
        selectedRegion = null;
        Plotly.restyle('mapa', { 'marker.line.width': [[0.2]] });
        hidePanel();
      });
    });
  </script>
</body>
</html>
